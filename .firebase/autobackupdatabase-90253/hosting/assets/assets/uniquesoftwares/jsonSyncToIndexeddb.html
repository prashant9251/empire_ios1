<!DOCTYPE html>
<html>
  <head>
    <script src="js/jsGetUrlParams.js"></script>
    <script>
      var url = window.location.href;
      var DSN = getUrlParams(url, "DatabaseSource");
      var Currentyear = getUrlParams(url, "Currentyear");
      var CURRENT_YEAR = Currentyear;
      var ClDb = DSN.replace(Currentyear, "");
      var clnt = atob(ClDb);
      // //console.log(clnt);
      Curentyearforlocalstorage = getUrlParams(url, "Curentyearforlocalstorage");
      var privateNetworkIp = getUrlParams(url, "privateNetworkIp");
      var privateNetWorkSync = getUrlParams(url, "privateNetWorkSync");
      var LFolder = getUrlParams(url, "LFolder");
      var StorageType = getUrlParams(url, "StorageType");
      var http = getUrlParams(url, "http");
      var ServerLocation = getUrlParams(url, "ServerLocation");

      // //console.log("--ONLINE--" + navigator.onLine);
      var Enavigator = navigator.onLine;
    </script>
    <script src="js/localStorageGet.js"></script>
    <script src="js/localStorageSet.js"></script>
    <title>CURRENT_YEAR</title>
    <style>
      #myProgress {
        width: 100%;
        background-color: grey;
      }

      #myBar {
        width: 1%;
        height: 30px;
        background-color: #4caf50;
        text-align: center;
        /* To center it horizontally (if you want) */
        line-height: 30px;
        /* To center it vertically */
        color: white;
      }
    </style>
    <link href="4.1.1/bootstrap.min.css" rel="stylesheet" id="bootstrap-css" />
    <link href="1.10.4/jquery-ui.css" rel="stylesheet" />
    <script src="1.10.2/jquery.js"></script>
    <script src="1.10.4/jquery-ui.js"></script>
  </head>

  <body>
    <h2 id="currentYearHead"></h2>
    <div id="myProgress">
      <div id="myBar"></div>
    </div>
    <div id="myPersent">1%</div>
    <p id="demo">SYNC DATA</p>
    <div id="forRetry"></div>

    <!-- <script src="js/jsprevents.js"></script> -->
    <script src="2.1.3/jquery.min.js"></script>

    <script src="js/jsStoreDatatoIndexeddb.js"></script>
    <script src="js/jscreateDatabase.js"></script>
    <script src="js/jsGetDateFormate.js"></script>
    <script src="js/jsGetObjectByKey.js"></script>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <!--------------------------FIRBASE LIBRARIES-------------------------------------------------->
    <!-- <script src="firebasejs/8.6.2/firebase-app.js"></script>
  <script src="firebasejs/8.6.2/firebase-auth.js"></script>
  <script src="firebasejs/8.6.2/firebase-database.js"></script>
  <script src="firebasejs/8.6.2/firebase-storage.js"></script> -->
    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->

    <!-- <script id="MainScript" src="firebasejs/8.6.2/connFirebase.js"></script> -->

    <script src="js/localStorageSet.js"></script>
    <script src="js/syncOperation.js"></script>
    <!-- <script src="jsKey.js"></script> -->
    <script>
      document.getElementById("currentYearHead").innerHTML =
        "YEAR-" + CURRENT_YEAR;
      document.title = "YEAR-" + CURRENT_YEAR;
      // key = ["OUTSTANDING"];

      arr = [];
      failArr = [];
      var lastUpdatetime = "";
      var newDate = new Date();
      var width = 0;
      var keyLength;
      function frame(width) {
        var elem = document.getElementById("myBar");
        elem.style.width = width + "%";
        document.getElementById("myPersent").innerHTML =
          Math.round(width) + "%";
        width = width;
        if (width > 99) {
          ExtraDataOpt();
          changeprogressBar(width);
          alert(lastUpdatetime);
          // document.location.href = "./../jsonHandler.php";
        }
      }
      $(document).ready(function () {
        load_Data(Currentyear).then(function (d) {
          keyLength = key.length;
          for (let i = 0; i < key.length; i++) {
            loadDoc(key[i]);
          }
        });
      });
      function load_Data(year) {
        return new Promise(function (resolve, reject) {
          createDatabase(ClDb + year, keyArrayInDatabase).then(
            function (d) {
              // //console.log(d);
              resolve(d);
            },
            function (error) {
              // //console.log(error);
              // reject(error);
            }
          );
        });
      }
      // loadDoc("BLS");
      function loadDoc(key) {
        var newDate = new Date();
        var data;
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            data = this.responseText;
            // data=atob(data);
            if (key == "TIME") {
              if (data.length > 0) {
                var TIMEarray = JSON.parse(data);
                if (TIMEarray.length > 0) {
                  if (TIMEarray[0].TIME != undefined) {
                    var TIME = TIMEarray[0].TIME;
                    lastUpdatetime = TIME;
                    if (lastUpdatetime == undefined || lastUpdatetime == null) {
                      lastUpdatetime = "";
                    }
                  }
                }
              }
            }
            $("#demo").append(`<div id=` + key + `><h6>` + key + `</h6></div>`);
            var JsonData = JSON.parse(data);
            if (JsonData.length > 0) {
              switch (key) {
                case "BLS":
                  SYNCBLS = JsonData;
                  break;
                case "OUTSTANDING":
                  SYNCOUTSTANDING = JsonData;
                  break;
                case "ACGROUP":
                  SYNCACGROUP = JsonData;
                  break;
                case "MST":
                  data = mstOpt(JsonData);
                  SYNCMST = JsonData;
                  break;
              }
              //console.log((JsonData));
              storedatatoIndexdb(DSN, key, data).then(
                function (data) {
                  arr.push(key);
                  var size = xhttp.response.length;
                  $("#" + key).html(
                    `<h6><span style='font-size:30px;color:green;'>&#10004;</span>` +
                      key +
                      `</h6>`
                  );
                  //   document.getElementById("demo").innerHTML = +" "+size
                  width = width + 100 / keyLength;
                  frame(width);
                },
                function (error) {
                  $("#" + key).html(
                    `<h6><span style='font-size:30px;color:green;'></span>` +
                      error +
                      `</h6>`
                  );
                }
              );
            } else {
              $("#" + key).html(
                `<h6><span style='font-size:30px;color:green;'>&times;</span>` +
                  key +
                  `</h6>`
              );
              width = width + 100 / keyLength;
              frame(width);
            }
          }
        };
        var timeoutSecond;
        if (
          privateNetworkIp != "" &&
          privateNetworkIp != null &&
          privateNetWorkSync == "true"
        ) {
          timeoutSecond = 90;
          hostToSync = "http://" + privateNetworkIp;
          enc1 = "VU5JUVVFU09GVFdBUkVT";
          enc2 = "U09GVFdBUkVTVU5JUVVF";
          var URLKEY =
            hostToSync +
            "/" +
            LFolder +
            "/js/" +
            enc1 +
            ClDb +
            enc2 +
            "/" +
            Currentyear +
            "/json/iaccess.php?tm=" +
            newDate;
          document.getElementById("demo").innerHTML =
            "SYNC DATA BY PRIVATE NETWORK " + privateNetworkIp;

        } else {
          timeoutSecond = 100;
          var URLKEY =
            "https://" +
            ServerLocation +
            "/CLIENT/DATA/" +
            clnt +
            "/" +
            ClDb +
            "/" +
            Currentyear +
            "/iaccess.php?tm=" +
            newDate;
          if (Enavigator == false) {
            document.getElementById("demo").innerHTML =
              "PLEASE CHECK YOUR INTERNET CONNECTION";
          } else if (Enavigator == true) {
            document.getElementById("demo").innerHTML = "SYNC DATA BY INTERNET";
          }
        }
        xhttp.open("POST", URLKEY, true);
        xhttp.onerror = function (error) {
          failArr.push(key);
          // loadDoc(key);
          $("#forRetry").html(
            `<button style="font-size:24px" onclick="reloadPendingJson();">Retry <i class="fa fa-refresh"></i></button>`
          );
          // //console.log(failArr);
          $("#demo").append(
            `<div id="Errorkey"><h6> Error Sync in `+(error.message) + key + ` </h6></div>`
          );
        };
        xhttp.timeout = 1000 * timeoutSecond; // Set timeout to 4 seconds (4000 milliseconds)
        xhttp.ontimeout = function () {
          loadDoc(key);
          //console.log(key, "timeout");
          $("#demo").append(
            `<div id="Retry` +
              key +
              `"><h6>` +
              key +
              `: Timeout Auto Retrying </h6></div>`
          );
        };
        xhttp.setRequestHeader(
          "Content-type",
          "application/x-www-form-urlencoded"
        );
        // //console.log(URLKEY);

        xhttp.send("Musertoken=" + ClDb + "&key=" + key);
      }

      function reloadPendingJson() {
        $("#Errorkey").css("display", "none");
        $("#Errorkey").hide();
        for (var i = 0; i < failArr.length; i++) {
          loadDoc(failArr[i]);
        }
      }
      function setNotification() {
        Android.setNotificationForAndroid("ok");
      }

      function changeprogressBar(persent) {
        try {
          if (isFlutterInAppWebViewReady) {
            args = obj = {};
            obj.lastUpdatetime = lastUpdatetime;
            obj.persent = persent;
            window.flutter_inappwebview.callHandler("Android", obj);
          }
        } catch (error) {}
      }

      var UserFullDetails = [];

      // or using a global flag variable
      var isFlutterInAppWebViewReady = false;
      window.addEventListener(
        "flutterInAppWebViewPlatformReady",
        function (event) {
          isFlutterInAppWebViewReady = true;
        }
      );
      // then, somewhere in your code
    </script>
  </body>
</html>
