<!DOCTYPE html>
<html>

<head>
  <script src="js/jsGetUrlParams.js"></script>
  <script>
    var url = window.location.href;
    var DSN = getUrlParams(url, "DatabaseSource");
    var Currentyear = getUrlParams(url, "Currentyear");
    var CURRENT_YEAR = Currentyear;
    var ClDb =getUrlParams(url, "CLDB");
    var clnt =getUrlParams(url, "CLNT");
    var privateNetworkIp = getUrlParams(url, "privateNetworkIp");
    var privateNetWorkSync = getUrlParams(url, "privateNetWorkSync");
    var http = getUrlParams(url, "http");
    var ServerLocation = getUrlParams(url, "ServerLocation");
    var LFolder = getUrlParams(url, "LFolder");

  </script>
  <script src="js/localStorageSet.js"></script>
  <title>CURRENT_YEAR</title>
  <style>
    #myProgress {
      width: 100%;
      background-color: grey;
    }

    #myBar {
      width: 1%;
      height: 30px;
      background-color: #4CAF50;
      text-align: center;
      /* To center it horizontally (if you want) */
      line-height: 30px;
      /* To center it vertically */
      color: white;
    }
  </style>
  <link href="4.1.1/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
  <link href="1.10.4/jquery-ui.css" rel="stylesheet">
  <script src="1.10.2/jquery.js"></script>
  <script src="1.10.4/jquery-ui.js"></script>
</head>

<body>

  <h2 id="currentYearHead"></h2>
  <div id="myProgress">
    <div id="myBar"></div>
  </div>
  <div id="myPersent">1%</div>
  <p id="demo">SYNC DATA</p>
  <div id="forRetry"></div>

  <!-- <script src="js/jsprevents.js"></script> -->
  <script src="2.1.3/jquery.min.js"></script>

  <script src="js/jsStoreDatatoIndexeddb.js"></script>
  <script src="js/jscreateDatabase.js"></script>
  <script src="js/jsGetObjectByKey.js"></script>
  <script src="jsKey.js"></script>

  <script>

    document.getElementById('currentYearHead').innerHTML = "YEAR-" + CURRENT_YEAR;
    document.title = "YEAR-" + CURRENT_YEAR;

    arr = [];
    failArr = [];

    var lastUpdatetime;

    var newDate = new Date();
    var width = 0;
    var keyLength
    function frame(width) {
      var elem = document.getElementById("myBar");
      elem.style.width = width + "%";
      document.getElementById("myPersent").innerHTML = Math.round(width) + "%"
      width = width;
      if (width > 99) {
        alert(lastUpdatetime);
      }
      changeprogressBar(width)
    }
    $(document).ready(function () {
      load_Data(Currentyear).then(function (d) {
        keyLength = key.length;
        for (let i = 0; i < key.length; i++) {
          loadDoc(key[i]);
        }
      })
    });
    function load_Data(year) {
      return new Promise(function (resolve, reject) {
        createDatabase(ClDb + year, keyArrayInDatabase).then(function (d) {
          //console.log(d);
          resolve(d);
        }, function (error) {
          //console.log(error);
          // reject(error);
        })
      })
    }
    function loacCall(load_Data) {
      keyLength = key.length;
      for (var i = 0; i < key.length; i++) {
        loadDoc(key[i]);
      }
    }


    // loadDoc("BLS");
    function loadDoc(key) {
      var newDate = new Date();
      var data;
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {

          data = this.responseText;
          // data=atob(data);
          if (key == 'TIME') {
            if (data.length > 0) {
              var TIMEarray = JSON.parse(data);
              if (TIMEarray.length > 0) {
                if (TIMEarray[0].TIME != undefined) {
                  var TIME = TIMEarray[0].TIME;
                  lastUpdatetime = TIME;
                  if (lastUpdatetime == undefined || lastUpdatetime == null) {
                    lastUpdatetime = "";
                  }
                }
              }
            }
          }
          $('#demo').append(`<div id=` + key + `><h6>` + key + `</h6></div>`);

          if (JSON.parse(data).length > 0) {
            storedatatoIndexdb(DSN, key, data).then(function (data) {
              arr.push(key);
              var size = xhttp.response.length;
              $('#' + key).html(`<h6><span style='font-size:30px;color:green;'>&#10004;</span>` + key + `</h6>`);
              width = width + 100 / keyLength;
              frame(width);
            }, function (error) {
              //console.log(error);
            });
          } else {
            $('#' + key).html(`<h6><span style='font-size:30px;color:green;'>&times;</span>` + key + `</h6>`);
            width = width + 100 / keyLength;
            frame(width);
          }
        }
      };
      var timeoutSecond;
      if (privateNetworkIp != "" && privateNetworkIp != null && privateNetWorkSync == "true") {
        timeoutSecond = 90;
        hostToSync = "http://" + privateNetworkIp;
        enc1 = "VU5JUVVFU09GVFdBUkVT";
        enc2 = "U09GVFdBUkVTVU5JUVVF";
        var URLKEY = hostToSync + "/" + LFolder + "/js/" + enc1 + ClDb + enc2 + "/" + Currentyear + "/json/access.php?tm=" + newDate;
        document.getElementById("demo").innerHTML = "SYNC DATA BY PRIVATE NETWORK IP :" + privateNetworkIp
      } else {
        timeoutSecond = 120;
        //alert(URLKEY)
        var URLKEY = http + ServerLocation + "/CLIENT/DATA/" + clnt + "/" + ClDb + "/"+ Currentyear + "/access.php?tm=" + newDate;
        document.getElementById("demo").innerHTML = "SYNC DATA BY INTERNET"
      }
      xhttp.open("POST", URLKEY, true);
      xhttp.onerror = function () {
        failArr.push(key)
        // loadDoc(key);
        $('#forRetry').html(`<button style="font-size:24px" onclick="reloadPendingJson();">Retry <i class="fa fa-refresh"></i></button>`);
        //console.log(failArr);
        $('#demo').append(`<div id="Errorkey"><h6> Error Sync in ` + key + ` </h6></div>`);
      };
      xhttp.timeout = 1000 * timeoutSecond; // Set timeout to 4 seconds (4000 milliseconds)
      xhttp.ontimeout = function () {
        loadDoc(key);
        //console.log(key, "timeout")
        $('#demo').append(`<div id="Retry` + key + `"><h6>` + key + `: Timeout Auto Retry </h6></div>`);
      }
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhttp.send("Musertoken=" + ClDb + "&key=" + key);
    }

    function reloadPendingJson() {
      $('#Errorkey').css("display", "none");
      $('#Errorkey').hide();
      for (var i = 0; i < failArr.length; i++) {
        loadDoc(failArr[i]);
      }

    }


    //console.log(Currentyear, Curentyearforlocalstorage);
    function changeprogressBar(persent) {
      try {
        Android.changeprogressBarTradingHome(persent);
        if (persent > 99) {
          if (Currentyear == Curentyearforlocalstorage) {
            Android.agencyHomeSetNewUpdateDate(lastUpdatetime);
          }
        }
      } catch (error) {
      }
    }

  </script>

</body>

</html>