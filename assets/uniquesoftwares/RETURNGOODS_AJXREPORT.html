<html>

<head>
  <title> RETURN GOODS </title>
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <link href="4.1.1/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
  <link href="1.10.4/jquery-ui.css" rel="stylesheet">
  <script src="1.10.2/jquery.js"></script>
  <script src="1.10.4/jquery-ui.js"></script>
  <script src="js/jsGetUrlParams.js"></script>
</head>

<body class="loader-enabled">
  <div align="center" class="table-responsive">
    <table id="result" class="content-table">

    </table>
  </div>
  <div style="display: none;" id="loader">
    <div class="loader"></div>
    <div style="text-align: center; margin-top: -80px; font-weight:700">Please wait...</div>
  </div>
</body>

<script>
  var url = window.location.href;
  var DSN = getUrlParams(url, "DatabaseSource");
</script>
<script src="js/localStorageGet.js"></script>
<script src="js/jsopenSubReport.js"></script>
<script src="js/jsGetYearChange.js"></script>
<script src="js/jsGetObjectByKey.js"></script>
<script src="js/jsfunction.js"></script>
<script src="js/jsgetEMPdata.js"></script>
<script src="js/jstoFixed.js"></script>
<script src="js/jsgetArrayProductdetailsbyIDE.js"></script>
<script src="js/jsGetDateFormate.js"></script>
<script src="js/jsLoadCallBLS.js"></script>
<script src="js/jsgetValueNotDefine.js"></script>
<script src="js/jsOpenBillDetilasAsTable.js"></script>

<script>
  var Data;
  var PAID = 'N';
  var ATYPE = '1';
  var tr = '';
  var FIRM = getUrlParams(url, "FIRM");

  var cno = '';
  var EMP;
  var partyname = getUrlParams(url, "partyname");
  var partycode = getUrlParams(url, "partycode");

  if (partyname == '') {
    partycode = '';
  }
  var broker = getUrlParams(url, "broker");
  var CITY = getUrlParams(url, "city");
  var haste = getUrlParams(url, "haste");
  var fromdate = getUrlParams(url, "search_FromDate");
  var todate = getUrlParams(url, "search_ToDate");
  GRD = getUrlParams(url, "GRD");
  var productDet = getUrlParams(url, "productDet");
  var CrntYearStartdate = getUrlParams(url, "CrntYearStartdate");

  if (fromdate == '' || fromdate == null) {
    if (CrntYearStartdate != '' || CrntYearStartdate != null) {
      fromdate = CrntYearStartdate;
    }
  }
  var nowDate = new Date();
  if (FIRM != '') {
    jsGetObjectByKey(DSN, "COMPMST", "").then(function (data) {
      //console.log(data);
      DataCompmst = data;
      for (var i = 0; i < DataCompmst.length; i++) {
        if (DataCompmst[i].FIRM == FIRM) {
          cno = DataCompmst[i].CNO;
        }
      }
    })
  }
  $(document).ready(function () {
    $("#loader").addClass('has-loader');
    load_data();
  });
  function load_data() {
    jsGetObjectByKey(DSN, "MST", "").then(function (data) {
      masterData = data;
      try { AddHeaderTbl(); } catch (error) { }
      jsGetObjectByKey(DSN, "BLS", "").then(function (data) {
        Data = data;

        var ReportType = getUrlParams(url, "ReportType");
        var ReportSeriesTypeCode = getUrlParams(url, "ReportSeriesTypeCode");
        var ReportATypeCode = getUrlParams(url, "ReportATypeCode");
        var ReportDOC_TYPECode = getUrlParams(url, "ReportDOC_TYPECode");

        //console.log(ReportType, ReportSeriesTypeCode, ReportATypeCode, ReportDOC_TYPECode);
        var ReportDOC_TYPECode_CN = "";
        var ReportDOC_TYPECode_DN = "";
        if (ReportType != "" && ReportType != null) {
          if (ReportSeriesTypeCode.toUpperCase() == 'P') {
            ReportDOC_TYPECode = "ZP";
            ReportDOC_TYPECode_CN = "CN";
            ReportDOC_TYPECode_DN = "DN";
            ReportSeriesTypeCode = "";
          } else if (ReportSeriesTypeCode.toUpperCase() == 'S') {
            ReportDOC_TYPECode = "OS";
            ReportDOC_TYPECode_CN = "CN";
            ReportDOC_TYPECode_DN = "DN";
            ReportSeriesTypeCode = "";
          }

          if (ReportATypeCode != "" && ReportATypeCode != "" && ReportATypeCode != undefined) {
            Data = Data.filter(function (data) {
              return data.billDetails.some((bill) => ((bill.ATYP)) == (ReportATypeCode) && (bill.DT) != null);
            }).map(function (subdata) {
              return {
                code: subdata.code,
                billDetails: subdata.billDetails.filter(function (bill) {
                  return ((bill.ATYP)) == (ReportATypeCode) && (bill.DT) != null;
                })
              }
            })
          }
          if (ReportDOC_TYPECode_CN != "" && ReportDOC_TYPECode_DN != "" && ReportDOC_TYPECode != "") {
            Data = Data.filter(function (data) {
              return data.billDetails.some((bill) =>
                bill.DT.toUpperCase().indexOf(ReportDOC_TYPECode_CN) > -1
                || bill.DT.toUpperCase().indexOf(ReportDOC_TYPECode_DN) > -1 ||
                bill.DT.toUpperCase().indexOf(ReportDOC_TYPECode) > -1);
            }).map(function (subdata) {
              return {
                code: subdata.code,
                billDetails: subdata.billDetails.filter(function (bill) {
                  return bill.DT.toUpperCase().indexOf(ReportDOC_TYPECode_CN) > -1
                    || bill.DT.toUpperCase().indexOf(ReportDOC_TYPECode_DN) > -1 ||
                    bill.DT.toUpperCase().indexOf(ReportDOC_TYPECode) > -1;
                })
              }
            })
          }
          if (ReportDOC_TYPECode != "" && ReportDOC_TYPECode != "" && ReportDOC_TYPECode != undefined) {
            Data = Data.filter(function (data) {
              return data.billDetails.some((bill) => bill.DT.toUpperCase().indexOf(ReportDOC_TYPECode) > -1
                || bill.DT.toUpperCase().indexOf(ReportDOC_TYPECode_DN) > -1 ||
                bill.DT.toUpperCase().indexOf(ReportDOC_TYPECode_CN) > -1);
            }).map(function (subdata) {
              return {
                code: subdata.code,
                billDetails: subdata.billDetails.filter(function (bill) {
                  return bill.DT.toUpperCase().indexOf(ReportDOC_TYPECode) > -1
                    || bill.DT.toUpperCase().indexOf(ReportDOC_TYPECode_DN) > -1 ||
                    bill.DT.toUpperCase().indexOf(ReportDOC_TYPECode_CN) > -1;
                })
              }
            })
          }

          if (ReportSeriesTypeCode != "" && ReportSeriesTypeCode != "" && ReportSeriesTypeCode != undefined) {
            Data = Data.filter(function (data) {
              return data.billDetails.some((bill) => ((bill.TYPE).toUpperCase()).indexOf(ReportSeriesTypeCode.toUpperCase())) > -1;
            }).map(function (subdata) {
              return {
                code: subdata.code,
                billDetails: subdata.billDetails.filter(function (bill) {
                  return ((bill.TYPE).toUpperCase()).indexOf(ReportSeriesTypeCode.toUpperCase()) > -1;
                })
              }
            })
          }


        }

        if (cno != '' && cno != null) {
          Data = Data.filter(function (data) {
            return data.billDetails.some((billDetails) => billDetails['CNO'] === cno);
          }).map(function (subdata) {
            return {
              code: subdata.code,
              billDetails: subdata.billDetails.filter(function (billDetails) {
                return (billDetails['CNO'] === cno);
              })
            }
          })
        }
        //  //console.log("BLS",Data);
        if (partycode != '' && partycode != null) {
          partycode = partycode.trim();
          Data = Data.filter(function (data) {
            return data.code == partycode;
          })
        }
        //  //console.log("BLS",Data);
        if (this.broker != '' && this.broker != null) {
          Data = Data.filter(function (data) {
            return data.billDetails.some((billDetails) => billDetails['BCODE'] === this.broker);
          }).map(function (subdata) {
            return {
              code: subdata.code,
              billDetails: subdata.billDetails.filter(function (billDetails) {
                return (billDetails['BCODE'] === this.broker);
              })
            }
          })
        }
        //  //console.log("BLS",Data);
        if (CITY != '' && CITY != null) {
          Data = Data.filter(function (data) {
            return data.billDetails.some((billDetails) => billDetails['CITY'] == this.CITY);
          }).map(function (subdata) {
            return {
              code: subdata.code,
              billDetails: subdata.billDetails.filter(function (billDetails) {
                return (billDetails['CITY'] == this.CITY);
              })
            }
          })
        }
        //  //console.log("BLS",Data);
        if (haste != '' && haste != null) {
          Data = Data.filter(function (data) {
            return data.billDetails.some((billDetails) => billDetails['haste'] === haste);
          }).map(function (subdata) {
            return {
              code: subdata.code,
              billDetails: subdata.billDetails.filter(function (billDetails) {
                return (billDetails['haste'] === haste);
              })
            }
          })
        }

        if (groupname != '' && groupname != null && groupname != undefined) {
          Data = Data.filter(function (data) {
            return data.billDetails.some((billDetails) => billDetails['GP'] === groupname);
          }).map(function (subdata) {
            return {
              code: subdata.code,
              billDetails: subdata.billDetails.filter(function (billDetails) {
                return (billDetails['GP'] === groupname);
              })
            }
          })
        }
        // //console.log("BLS", Data);
        if (fromdate !== '' && fromdate !== null) {
          Data = Data.filter(function (data) {
            return data.billDetails.some((billDetails) => new Date(billDetails.DATE).setHours(0, 0, 0, 0) >= new Date(fromdate).setHours(0, 0, 0, 0));
          }).map(function (subdata) {
            return {
              code: subdata.code,
              billDetails: subdata.billDetails.filter(function (billDetails) {
                return new Date(billDetails.DATE).setHours(0, 0, 0, 0) >= new Date(fromdate).setHours(0, 0, 0, 0);
              })
            }
          })
        }
        // //console.log("BLS", Data);
        if (todate !== '' && todate !== null) {
          Data = Data.filter(function (data) {
            return data.billDetails.some((billDetails) => new Date(billDetails.DATE).setHours(24, 0, 0, 0) <= new Date(todate).setHours(24, 0, 0, 0));
          }).map(function (subdata) {
            return {
              code: subdata.code,
              billDetails: subdata.billDetails.filter(function (billDetails) {
                return new Date(billDetails.DATE).setHours(24, 0, 0, 0) <= new Date(todate).setHours(24, 0, 0, 0);
              })
            }
          })
        }

        if (GRD != '' && GRD != null && GRD != undefined) {
          Data = Data.filter(function (data) {
            return data.billDetails.some((billDetails) => billDetails['GRD'] === GRD);
          }).map(function (subdata) {
            return {
              code: subdata.code,
              billDetails: subdata.billDetails.filter(function (billDetails) {
                return (billDetails['GRD'] === GRD);
              })
            }
          })
        }
        loadCall(Data);
      });
    })
  }


</script>
<script src="js/jsHeaderTbl.js"></script>