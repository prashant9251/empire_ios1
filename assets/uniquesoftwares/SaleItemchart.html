<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <script src="2.1.3/jquery.min.js"></script>
  <script src="3.3.6/bootstrap.min.js"></script>
  <link href="3.3.6/bootstrap.min.css" rel="stylesheet" />
  <script src="js/jsGetUrlParams.js"></script>
</head>
<script>
  var url = window.location.href;
  var MCNO = getUrlParams(url, "MCNO");
  var MTYPE = getUrlParams(url, "MTYPE");
  var DSN = getUrlParams(url, "DatabaseSource");
  var Currentyear = getUrlParams(url, "Currentyear");

</script>
<script src="js/localStorageSet.js"></script>
<script src="js/jsGetObjectByKey.js"></script>
<script src="js/jsStoreDatatoIndexeddb.js"></script>
<script src="js/jsPopUpTblSetting.js"></script>
<script src="js/jsoptionSeriesSelect.js"></script>
<script src="js/jsoptionFirmSelect.js"></script>
<script src="js/jsSearchfrm.js"></script>
<html>
<style>
  .progress-container {
    width: 100%;
    background-color: #bbafaf;
    border-radius: 0px;
    overflow: hidden;
  }

  .progress-bar {
    width: 0;
    height: 30px;
    background-color: #4caf50;
    text-align: center;
    line-height: 30px;
    color: white;
    border-radius: 0px;
  }
</style>

<head>
  <title>All Sale Report</title>
  <link href="4.1.1/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
  <link href="1.10.4/jquery-ui.css" rel="stylesheet">
  <script src="1.10.4/jquery-ui.js"></script>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/styleAutoComplete.css">
  <script src="js/jsGetDateFormate.js"></script>


</head>

<body>
  <div class="container" style="width: 100%; display: none; position: absolute; top: 0;" id="mainChartContainer"></div>
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card">
        <article class="card-body">
          <form action="" method="get" target="_blank" autocomplete="off">
            <div class="form-row">
              <div class="col form-group">
                <h4>FROM</h4>
                <input type="date" class="form-control inputText" placeholder="SEARCH FROM DATE" value=""
                  name="search_FromDate" id="search_FromDate" onchange="loadItemSaleChartTable();">
              </div>

              <div class="col form-group">
                <h4>TO</h4>
                <input type="date" class="form-control inputText" placeholder="SEARCH TO DATE" value=""
                  name="search_ToDate" id="search_ToDate" onchange="loadItemSaleChartTable();">
              </div>
            </div>
            <div class="form-row">
              <div class="col form-group">
                <h4>PARTY NAME</h4>
                <input class="form-control inputText" onfocus="this.value=''" autocomplete="off" onchange=""
                  placeholder="SEARCH BY PARTY NAME" name="partyname" id="partyname">
                <input type="hidden" class="form-control" id="partycode" name="partycode">
              </div>
              <div class="col form-group">
                <h4>CITY</h4>
                <input class="form-control inputText" onfocus="this.value=''" autocomplete="off" name="city" id="city"
                  placeholder="SEARCH BY CITY NAME">
              </div>
            </div>
            <div class="form-row">
              <div class="col form-group">
                <h4>TYPE</h4>
                <select class="form-control inputText" style="height: 40px;" id="series" name="series"
                  onchange="loadItemSaleChartTable();">
                </select>
              </div>
              <div class="col form-group">
                <h4>UNIT</h4>
                <select class="form-control inputText" style="height: 40px;" id="unit" name="unit"
                  onchange="loadItemSaleChartTable();">
                  <option value="PCS">PCS</option>
                  <option value="MTS">MTS</option>
                  <option value="AMT">AMT</option>
                </select>
              </div>
            </div>
            <div style="display: none;" id="loader">
              <div class="loader"></div>
              <div style="text-align: center; margin-top: -80px; font-weight:700">Please wait...</div>
            </div>
            <div id="result" class="table-responsive" style="transform: scale(1);transform-origin: 0 0;"></div>
          </form>
        </article>
      </div>
    </div>
  </div>
  </div>

</body>


</html>
<!DOCTYPE html>
<html>
<title>Bar Charts</title>
<script src="1.10.2/jquery.js"></script>
<script src="1.10.4/jquery-ui.js"></script>
<script src="js/jsGetUrlParams.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script> -->
<link href="3.3.6/bootstrap.min.css" rel="stylesheet" />
<link href="1.10.4/jquery-ui.css" rel="stylesheet">
<link rel="stylesheet" href="css/stylePrint.css">
<link rel="stylesheet" href="css/styleAutoComplete.css">

<body>
  <script src="js/jsGetObjectByKey.js"></script>
  <script>
    var url = window.location.href;
    var DSN = getUrlParams(url, "DatabaseSource");
    var Data = [];
    var unitType = 'PCS';
    var type = 'S1';
    var typeName = '';
    function loadItemSaleChartTable(evt) {
      unitType = $('#unit').val();
      type = $('#series').val();
      loadFilter();
    }
    $(document).ready(function () {
      $("#mainChartContainer").css("display", "");
      $("#loader").addClass('has-loader');
      setSearchToDate("search_ToDate");
      load_data();
    });
    var MAIN_DET = [];
    var MAIN_BLS = [];
    var DET_LIST = [];
    var qual_List = [];
    var qual_flg_List = [];
    var type_list = [];
    var type_flg_list = [];
    var SERIES = [];
    function load_data() {
      jsGetObjectByKey(DSN, "SERIES", "").then(function (SERIES) {
        this.SERIES = SERIES;
        jsGetObjectByKey(DSN, "BLS", "").then(function (BLS) {
          MAIN_BLS = BLS;
          jsGetObjectByKey(DSN, "DET", "").then(function (DET) {
            this.MAIN_DET = DET.map(function (d) {
              var billHeadDetails = getbillHeadDetails(d['CNO'], d['TYPE'], d['VNO']);
              //mearge d and billHeadDetails
              d = { ...d, ...billHeadDetails };
              if (!type_flg_list[d['TYPE']]) {
                var S = getSERIES(d['TYPE']);
                var name = '';
                if (S.length > 0) {
                  name = S[0]['SERIES'];
                  if (S[0]['DT'].toUpperCase() == 'OS') {
                    type = d['TYPE'];
                    typeName = name;
                  }
                }
                var obj = { SERIESCODE: d['TYPE'], SERIES: name, SERIESOBJ: S }
                type_list.push(obj);
                type_flg_list[d['TYPE']] = true;
              }
              return d;
            });
            loadTypeOption();
            loadFilter();
          })
        })
      })
    }
    function loadTypeOption() {
      var xfirm = document.getElementById('series');
      type_list.forEach(function (element, index) {
        var option = document.createElement("option");
        option.value = element.SERIESCODE;
        option.text = element.SERIES;
        xfirm.add(option, xfirm[0]);
      });
      xfirm.value = type;
    }
    function getSERIES(type) {
      var v = SERIES.filter(function (d) {
        return d.SERIESCODE == type;
      })
      return v;
    }

    function loadFilter() {
      $("#loader").addClass('has-loader');
      var DET = MAIN_DET.filter(function (d) {
        return d["TYPE"] == type;
      });
      var fromdate = $('#search_FromDate').val();
      var todate = $('#search_ToDate').val();
      var city = $('#city').val();
      var partycode = $('#partycode').val();
      var partyname = $('#partyname').val();
      if (partyname == null || partyname == '' || partyname == 'undefined') {
        partycode = '';
      }
      if (partycode !== '' && partycode !== null && partycode !== 'undefined') {
        DET = DET.filter(function (data) {
          return data.code == partycode
        })
      }

      if (city !== '' && city !== null && city !== 'undefined') {
        DET = DET.filter(function (data) {
          return data.CITY.toUpperCase().indexOf(city.toUpperCase()) > -1
        })
      }
      if (fromdate !== '' && fromdate !== null && fromdate !== 'undefined') {
        DET = DET.filter(function (data) {
          return new Date((data.DATE)).setHours(0, 0, 0, 0) >= new Date((fromdate)).setHours(0, 0, 0, 0)
        })
      }
      if (todate !== '' && todate !== null && todate !== 'undefined') {
        DET = DET.filter(function (data) {
          return new Date((data.DATE)).setHours(0, 0, 0, 0) <= new Date((todate)).setHours(0, 0, 0, 0)
        })
      }
      grandTot = 0;
      DET_LIST = [];
      qual_List = [];
      qual_flg_List = [];

      //////
      for (var i = 0; i < DET.length; i++) {
        var billDetails = DET[i].billDetails;
        for (var j = 0; j < billDetails.length; j++) {
          var item = billDetails[j];
          grandTot += parseFloat(item[unitType]);
          var obj = {
            TYPE: item.TYPE,
            qual: item.qual,
            unitType: item[unitType],
          };
          DET_LIST.push(obj);
          if (!qual_flg_List[item.qual]) {
            qual_List.push(item.qual);
            qual_flg_List[item.qual] = true;
          }
        }
      }
      var G_DET_LIST = [];
      for (var i = 0; i < qual_List.length; i++) {
        var total = getTotalOfItem(qual_List[i]);
        var PERSENT = total / grandTot * 100;
        var obj = {
          qual: qual_List[i],
          total: total,
          PERSENT: PERSENT,
          grandTot: grandTot,
        };
        G_DET_LIST.push(obj);
      }
      G_DET_LIST.sort(function (a, b) {
        return b.total - a.total;
      })
      Data = G_DET_LIST;
      loadData();
      $("#loader").removeClass('has-loader');

    }
    function getTotalOfItem(item) {
      var itemList = DET_LIST.filter(function (d) {
        return d.qual == item;
      })
      var total = 0;
      for (var i = 0; i < itemList.length; i++) {
        total += parseFloat(itemList[i]['unitType']);
      }
      return total;
    }


    function loadData() {
      var S = getSERIES(type);
      var SERIESNAME = '';
      if (S.length > 0) {
        SERIESNAME = S[0]['SERIES'];
      }
      var colorStyle = "color:#c107a2;";
      if (SERIESNAME.toString().toUpperCase().indexOf("RETURN") > -1 && SERIESNAME.toString().toUpperCase().indexOf("SALES") > -1) {
        colorStyle = "color: red;";
      }
      var totalOfQty = 0;
      var tr = `<table style="width:100%;border-collapse: separate;"  class="content-table" >
        <tbody>
        <tr class="trPartyHead style="font-size:20px;">
          <th style="width:10%;">Item</th>
          <th style="width:60%;">Bar</th>
          <th style="width:5%;" class='alignRight'><b id='totalOfQty'></b>${unitType}</th>
        </tr>
        `;
      for (var i = 0; i < Data.length; i++) {
        var e = Data[i];
        totalOfQty = e[`grandTot`];
        var openItemWiseSaleUrl = `ALLSALE_AJXREPORT.html?ntab=NTAB&REPORTTYPE=ITEM WISE LIST&ReportSeriesTypeCode=${type}&qualname=${e['qual']}&qualcode=${e['qual']}&search_FromDate=${$('#search_FromDate').val()}&search_ToDate=${$('#search_ToDate').val()}`;
        openItemWiseSaleUrl += `&partycode=${$('#partycode').val()}&partyname=${$('#partyname').val()}&city=${$('#city').val()}`;
        tr += `
        <tr style='border:1px solid black;'>
          <td style="width:10%;font-size:15px;">
            <a href="javascript:void(0);" style="${colorStyle}font-weight:bold; cursor:pointer;" onmouseover="this.style.color='#ffffff'" onmouseout="this.style.color='#007bff'" onclick="openItemWiseSale('${openItemWiseSaleUrl}','${type}')">${e['qual']}</a>
          </td>
          <td style="width:60%;">
            <div class="progress-container">
              <div class="progress-bar" style='width:${e[`PERSENT`]}%;color:black;font-size:15px;'>&nbsp; ${parseFloat(e[`PERSENT`]).toFixed(4)}%</div>
            </div>
          </td>   
          <td style="width:5%;font-size:15px;" class='alignRight'>${e['total']}</td>
        </tr>
          `;
      }
      tr += `</tbody></table>`;

      $('#result').html(tr);
      $('#totalOfQty').html(`(${totalOfQty})`)
    }

    function openItemWiseSale(url, type) {
      var S = getSERIES(type);
      var SERIESNAME = '';
      if (S.length > 0) {
        SERIESNAME = S[0]['SERIES'];
      }
      url = url + '&ReportType=' + SERIESNAME;
      window.open(url, '_blank');
    }
    function getbillHeadDetails(cno, type, vno) {
      var BLS = MAIN_BLS.filter(function (data) {
        return data.billDetails.some((billDetails) => billDetails['CNO'] === cno && billDetails['TYPE'] === type && billDetails['VNO'] === vno);
      }).map(function (subdata) {
        return {
          code: subdata.code,
          billDetails: subdata.billDetails.filter(function (billDetails) {
            billDetails['code'] = subdata.code;
            return (billDetails['CNO'] === cno && billDetails['TYPE'] === type && billDetails['VNO'] === vno);
          })
        }
      });
      try {
        return BLS[0].billDetails[0];
      } catch (e) {
        return {};
      }
    }
  </script>

</body>

</html>